# Подпрограммы

Написать подпрограмму SETABS, которая заменяет элемент массива байтов с заданным номером на его модуль.
Дано описание:
X DB 100 DUP(?) ; X[0..99]
Используя подпрограмму, решить задачу: при X[0] > X[27] заменить на модуль значение элемента X[27], иначе — элемента X[0].
Выполнить это задание при условии, что параметры передаются подпрограмме:
а) через регистр; б) через стек.

```x86asm
SETABS PROC

SETABS ENDP
```

Написать подпрограмму F(X, N, P), которая определяет, сколько элементов массива X из N байтов равно заданному значению P. Использовать эту подпрограммы для вычисления
K ≔ F(A, 70, F(B, 30, K)) где A — массив из 70 байтов, B — массив из 30 байтов, а K — байтовая переменная.

Выполнить это задание при условии, что параметры передаются подпрограмме:

а) через регистры; б) через стек.

```x86asm
F PROC
; X = ebx, N = ecx, P = al
; ret = dl
push rbx
push rcx
jecxz FFIN
mov dl, 0
FL1:
cmp [ebx], al
jne FM1
inc dl
FM1:
inc ebx
loop FL1
FFIN:
pop rcx
pop rbx
ret
F ENDP

N equ 70
A db ...
M equ 30
B db ...
K db ...

lea ebx, B
mov ecx, M
mov al, K
call F

lea ebx, A
mov ecx, N
mov al, dl
call F
```

```x86asm
F PROC
push rbp
mov rbp, rsp

; ret = dl
; [rbp] = rbp
; [rbp+8] = адрес возврата
; [rbp+16] = P
; [rbp+18] = N
; [rbp+26] = X

push rcx
push rbx
push ax

mov rbx, [rbp+26] # rbx = X
mov rcx, [rbp+18] # rcx = N
mov al, [rbp+16]  #  al = P
mov dl, 0
jrcxz F3
F1:
cmp [rbx], al
jne F2
inc dl
F2:
inc rbx
loop F1
F3:
pop ax
pop rcx
pop rbx
pop rbp
ret 18
F ENDP

N equ 70
A db ...
M equ 30
B db ...
K db ...

lea ebx, B
push rbx
mov rbx, M
push rbx
mov bl, K
push bx
call F

lea rbx, A
push rbx
mov rbx, N
push rbx
mov bl, dl
push bx
call F
```

# Макросредства

Макросредства представляют возможность предварительного (до начала трансляции) преобразования текста программы.
Расширение языка ассемблера 

1. Этап макрогенерации - программа переводится на язык ассемблера, т.е. преобразуется к виду где нет макросредств, этот этап выполняет специальный транслятор - макрогенератор.

2. Этап ассемблирования - программа, полученная на предыдущем этапе переводится на машинный язык. Этот этап выполняет ассемблер.

Макрогенератор и ассемблер могут взаимодействовать следующими способами:

Сначала текст программы обрабатывает макрогенератор, затем 

Этот способ прост для понимания и реализации, но макрогенератор не может воспользоваться информацией, 

```x86asm
REPT N
; тело макроса
ENDM
```

```x86asm
N equ 6
REPT N-4
db 0,1
dw ?
ENDM

N equ 6
db 0,1
dw ?
db 0,1
dw ?
```
